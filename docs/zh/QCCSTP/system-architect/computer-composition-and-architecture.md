# 计算机组成与体系结构

## 计算机硬件组成

![计算机组成-主机与外设](/assets/qccstp/计算机组成-主机与外设.png)

### 总线

一条总线`同一时刻仅允许一个设备发送，但允许多个设备接收。所以总线是半双工模式`

> - 半双工（Half Duplex）是一种传送制式。使用同一根传输线既作接收又作发送，数据可以在两个方向上传送，但通信双方不能同时收发数据，这种传送方式就是半双工制
> - 全双工模式（Full Duplex），是指当数据的发送和接收分流，分别由两根不同的传输线传送时，通信双方都能在同一时刻进行发送和接收操作的传送方式
> > 对于全双工和半双工的经典举例一般就是电话和对讲机

#### 总线的分类

- 数据总线（DB，Data Bus）：在CPU与RAM之间来回传送需要处理或是需要存储的数据
- 地址总线（AB，Address Bus）：用来指定在RAM（Random Access Memory）之中存储的数据的地址
- 控制总线（CB，Control Bus）：将微处理器控制单元（Control Unit）的信号传送到周边设备

## 计算机体系结构

### Flynn分类法

| 体系结构类型                                                   | 结构                           | 关键特性                  | 代表                          |
|----------------------------------------------------------|------------------------------|-----------------------|-----------------------------|
| 单指令单数据流<br>SISD<br>(Single instruction, Single data)     | 控制部分：一个<br>处理器：一个<br>主存模块：一个 |                       | 单处理器系统                      |
| 单指令多数据流<br>SIMD<br>(Single instruction, Multiple data)   | 控制部分：一个<br>处理器：多个<br>主存模块：多个 | 各处理器以异步的形式执行同一条指令     | 并行处理机<br>`阵列处理机`<br>超级向量处理机 |
| 多指令单数据流<br>MISD<br>(Multiple instruction, Single data)   | 控制部分：多个<br>处理器：一个<br>主存模块：多个 | 被证明不可能，至少是不实际         | 目前没有，有文献成`流水线计算机`为此类        |
| 多指令多数据流<br>MIMD<br>(Multiple instruction, Multiple data) | 控制部分：多个<br>处理器：多个<br>主存模块：多个 | 能够实现`作业、任务、指令`等各级全面并行 | 多计算机系统<br>多计算机              |

### CISC与RISC

| 指令系统类型 | 复杂指令集计算机（CISC，Complex Instruction Set Computers） | 精简指令集计算机（RISC，Reduced Instruction Set Computers）       |
|--------|--------------------------------------------------|--------------------------------------------------------|
| 指令     | 数量`多`，使用频率差别大，可变长格式                              | 数量`少`，`使用频率接近`，定长格式，大部分为单周期指令，`操作寄存器`，只有Load/Store操作内存 |
| 寻址方式   | 支持多种                                             | 支持方式少                                                  |
| 实现方式   | 微程序控制技术（微码）                                      | `增加了通用寄存器`；硬布线逻辑控制为主；`适合采用流水线`                         |
| 其他     | 研制周期长                                            | 优化编译，有效支持高级语言                                          |

### 冯·若依曼结构与哈佛结构

#### 冯·若依曼结构

冯·若依曼结构也称普林斯顿结构，是一种将程序指令存储器和数据存储器合并在一起的存储结构

特点

- 一般用于PC处理器，如I3、I5、I7处理器
- 指令与数据存储器合并在一起
- 指令与数据都通过相同的数据总线传输

#### 哈弗结构

哈佛结构是一种程序指令和数据存储分开的存储器结构。哈佛结构是一种并行体系结构，它的主要特点是将程序和数据存储在不同的存储器空间中，即程序存储器和数据存储器是两个独立的存储器，每个存储器独立编址、独立访问

特点

- 一般用于嵌入式相同处理器（DSP）
- 指令与数据分开存储，可以并行读取，有较高的数据吞吐率
- 有4条总线：指令和数据的数据总线与地址总线

> DSP：数字信号处理，Digital Signal Processing

## 存储系统

### 层次化存储结构

![存储系统-层次化存储结构](/assets/qccstp/存储系统-层次化存储结构.png)

#### 局部性原理

- 时间局部性：指程序种某指令一旦执行，不久以后该指令可能再次执行。典型原因是由于程序中存在者大量的循环操作
- 空间局部性：指一旦程序访问了某个存储单元，不久之后，其附近的存储单元也将被访问，即程序在一段时间内所访问的地址可能集中在一定的范围内。其典型情况是程序顺序执行

> - 局部性理论是层次化存储结构的支撑
> - 工作集理论：工作集是进程运行时被频繁访问的页面集合

#### Cache

- Cache的功能：提高CPU数据输入输出的速率，突破冯·诺依曼瓶颈，即CPU与存储系统间数据传输带宽限制。
- 在计算机的存储系统体系中，Cache是访问速度最快的层次（除寄存器以外）
- 使用Cache改善系统性能的依据是程序的局部性原理

> - 如果以h代表Cache的访问命中率，t~1~表示Cache的周期时间，t~2~表示主存储器周期时间，以读操作为例，使用“Cache+主存储器”的系统的平均周期为t~3~，则：
> $$
> t_3 = h \times t_1 + (1 - h) \times t_2\text{，其中 (1 - h) 又称为失效率（未命中率）}
> $$
> - Cache对与开发人员是透明的，一般用不到，但内外存、寄存器这些都是可以访问的

#### 主存/内存

##### 分类

- 相联存储器
  - 按内容存取，如 Cache
- 随机存取存储器（RAM，Random Access Memory）
  - DRAM（Dynamic RAM，动态 RAM）-> SDRAM（带同步机制的DRAM） 
  - SRAM（Static RAM，静态 RAM）
- 只读存储器（ROM，Read-Only Memory）
  - MROM（Mask ROM，掩模式 ROM）
  - PROM（Programmable ROM，一次可编程 ROM）
  - EPROM（Erasable PROM，可擦除的 PROM）
  - 闪速存储器（flash memory，闪存）

> BIOS使用ROM 

##### 编址计算

![存储系统-编址](/assets/qccstp/存储系统-编址.png)

- 存储单元个数计算：最大地址 + 1 - 最小地址
- 内存总容量 = 存储单元个数 * 编址内容
  - 按字节（1字节(B) = 8bit）编址，存储单元数 * 8bit
  - 按字编址，存储单元数 * 机器字长
- 总容量 = 单位芯片容量 * 芯片个数
  - 已知芯片单位容量，求所用芯片的片数，总容量/单位容量
  - 已知所用芯片的片数，求取芯片单位容量，总容量/芯片片数

#### 磁盘结构与参数

![存储系统-磁盘结构-1](/assets/qccstp/存储系统-磁盘结构-1.png)

- 存取时间 = 寻道时间 + 等待时间（平均定位时间 + 转动延迟）
  - 寻道时间是指磁头移动到磁道所需的时间
  - 等待时间为等待读写的扇区转到磁头下方所用的时间（有时还需要加上数据的传输时间）
- 在处理过程中，如果有关于缓冲区的使用，需要了解对于单缓冲区每次只能被一个进程使用，即向缓冲区传输数据的时候不能从缓冲区读取数据，反之亦然
- 对于磁盘存储的优化，是因为磁头保持转动的状态，当读取数据传输或处理时，磁头会移动到超前的位置，需要继续旋转才能回到逻辑下一磁盘块，优化存储就是调整磁盘块的位置，让逻辑下一磁盘块放到磁头将要开始读取该逻辑块的位置

##### 磁盘移臂调度算法

![存储系统-磁盘结构-2](/assets/qccstp/存储系统-磁盘结构-2.png)

- 先来先服务（FCFS，First Come,First Served）：谁先申请先服务谁
- 最短寻道时间优先（SSTF，Shortest Seek Time First）：申请时判断与磁头当前位置的距离，谁短先服务谁
- 扫描算法 SCAN：也叫电梯算法，将盘面看作电梯楼层，每次单方向运动，如同电梯上楼下楼，双向扫描
- 循环扫描 CSCAN：单向扫描。类比水井打水的过程，每次都将水桶丢回井底，打满再拉上来

## 流水线技术

### 概念

流水线是指在程序执行时`多条指令重叠进行操作`的一种准并行处理实现技术。各种部件同时处理是针对不同指令而言的，它们可同时为多条指令的不同部分进行工作，以提高各部件的利用率和指令的平均执行速度

![流水线技术-概念](/assets/qccstp/流水线技术-概念.png)

### 流水线计算

- 流水线建立时间：一条指令执行时间
- 流水线周期：执行时间最长的一段
- `流水线计算公式`
  - 理论公式
  $$
  (t_1 + t_2 + \dots + t_k) + (n - 1) \times \Delta_t
  $$
  ![流水线技术-流水线计算-理论公式](/assets/qccstp/流水线技术-流水线计算-理论公式.png)
  > 最长的执行时间其实就是流水线的瓶颈所在
  - 实践公式
  $$
  k \times \Delta_t + (n - 1) \times \Delta_t
  $$
  ![流水线技术-流水线计算-实践公式](/assets/qccstp/流水线技术-流水线计算-实践公式.png)
- 流水线吞吐率（TP，Throughput rate）：指在`单位时间内流水线所完成的任务数量或输出的结果数量`
  $$
  TP = \frac {\text{指令条数}} {\text{流水线执行时间}}
  $$
- 流水线最大吞吐率（即流水线周期的倒数）
  $$
  TP_{max} = \lim_{0 \to \infty} \frac n {(k + n - 1) \times \Delta_t} = \frac 1 \Delta_t
  $$
- 流水线加速比：不使用流水线所用时间和使用流水线所用时间的比值（简记：加速比一般是大于1的，所以大值是分子）
  $$
  S = \frac {\text{不使用流水线执行时间}} {\text{使用流水线执行时间}}
  $$

#### 超标量流水线

![流水线技术-超标量流水线](/assets/qccstp/流水线技术-超标量流水线.png)

简单来说，就是多个流水线并行处理。假设有n条指令，有k组流水线，执行时间为（理论公式）
$$
(t_1 + t_2 + \dots + t_{\lceil {\frac n k} \rceil}) + (n - 1) \times \Delta_t
$$

## 校验码

## 嵌入式系统